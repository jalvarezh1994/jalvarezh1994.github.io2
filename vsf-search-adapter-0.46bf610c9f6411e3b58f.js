(window.webpackJsonp=window.webpackJsonp||[]).push([[163],{655:function(e,r,t){"use strict";t.r(r);var n=t(3),s=t(707),o=t(1);function i(){if(!o.elasticsearch.hasOwnProperty("searchScoring"))return!1;var e,r,t,n=[],s=o.elasticsearch.searchScoring.attributes;if(!Object.keys(s).length)return!1;for(var i=0,u=Object.keys(s);i<u.length;i++)for(var a=u[i],c=0,l=Object.keys(s[a].scoreValues);c<l.length;c++){var h=l[c],f={filter:{match:(e={},r=a,t=h,r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e)},weight:s[a].scoreValues[h].weight};n.push(f)}return!!n.length&&{functions:n,score_mode:o.score_mode?o.score_mode:"multiply",boost_mode:o.boost_mode?o.boost_mode:"multiply",max_boost:o.max_boost?o.max_boost:100,min_score:o.function_min_score?o.function_min_score:1}}function u(e){return function(e){var r=o.elasticsearch.hasOwnProperty("searchScoring")?o.elasticsearch.searchScoring:{},t="";t="GET"===o.elasticsearch.queryMethod?r.hasOwnProperty("minimum_should_match")?r.minimum_should_match+"25":"75%25":r.hasOwnProperty("minimum_should_match")?r.minimum_should_match:"75%";var n={query:e,operator:r.operator?r.operator:"or",fuzziness:r.fuzziness?r.fuzziness:"2",cutoff_frequency:r.cutoff_frequency?r.cutoff_frequency:"0.01",max_expansions:r.max_expansions?r.max_expansions:"3",prefix_length:r.prefix_length?r.prefix_length:"1",minimum_should_match:t,tie_breaker:r.tie_breaker?r.tie_breaker:"1"};return r.hasOwnProperty("analyzer")&&(n.analyzer=r.analyzer),n}(e)}function a(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",r=[];return o.elasticsearch.hasOwnProperty("searchableAttributes")&&o.elasticsearch.searchableAttributes[e]&&(r=o.elasticsearch.searchableAttributes[e]),r.hasOwnProperty("boost")?r.boost:1}function c(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"products",t=[];return o.hasOwnProperty(r)&&o[r].hasOwnProperty("filterFieldMapping")&&(t=o[r].filterFieldMapping),t.hasOwnProperty(e)?t[e]:e}var l=t(270),h=1,f=4;var p=function(e){return Object(l.a)(e,h|f)};function y(e,r,t,n,s,o,i){try{var u=e[o](i),a=u.value}catch(e){return void t(e)}u.done?r(a):Promise.resolve(a).then(n,s)}function g(e){return d.apply(this,arguments)}function d(){var e;return e=regeneratorRuntime.mark(function e(r){var n,s,l,h,f,y,g,d,b,m,_,v,w,P,O,x,k,q;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.e(136).then(t.t.bind(null,1199,7));case 2:if(n=e.sent,"_options",s=r.getSearchText(),l=["gt","lt","gte","lte","moreq","from","to"],h=n.default(),(f=p(r.getAppliedFilters())).length>0&&(y=!1,f.forEach(function(e){"default"===e.scope?Object.keys(e.value).every(function(e){return l.includes(e)})?h=h.filter("range",e.attribute,e.value):(e.value=e.value[Object.keys(e.value)[0]],Array.isArray(e.value)||(e.value=[e.value]),h=h.filter("terms",c(e.attribute),e.value)):"catalog"===e.scope&&(y=!0)}),g=function(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return f.forEach(function(t){var n=Object.keys(t.value);if("catalog"===t.scope&&n.length)if(n.filter(function(e){return-1!==l.indexOf(e)}).length){var s=t.attribute;"price"===s&&(s="final_price"),e=e.andFilter("range",s,t.value)}else{var o=t.value[Object.keys(t.value)[0]];Array.isArray(o)||(o=[o]),e=""===r?e.andFilter("terms",c(t.attribute),o):e.andFilter("terms",t.attribute+r,o)}}),e},y&&(h=h.orFilter("bool",function(e){return g(e)}).orFilter("bool",function(e){return g(e,"_options").filter("match","type_id","configurable")}))),!((d=r.getAvailableFilters()).length>0)){e.next=30;break}for(b=!0,m=!1,_=void 0,e.prev=14,v=d[Symbol.iterator]();!(b=(w=v.next()).done);b=!0)"catalog"===(P=w.value).scope&&("price"!==P.field?(O={size:o.products.filterAggregationSize[P.field]||o.products.filterAggregationSize.default},h=(h=h.aggregation("terms",c(P.field),O)).aggregation("terms",P.field+"_options",O)):(h=h.aggregation("terms",P.field)).aggregation("range","price",o.products.priceFilters));e.next=22;break;case 18:e.prev=18,e.t0=e.catch(14),m=!0,_=e.t0;case 22:e.prev=22,e.prev=23,b||null==v.return||v.return();case 25:if(e.prev=25,!m){e.next=28;break}throw _;case 28:return e.finish(25);case 29:return e.finish(22);case 30:return x=function(e){for(var r=o.elasticsearch.hasOwnProperty("searchableAttributes")?o.elasticsearch.searchableAttributes:{name:{boost:1}},t=[],n=0,i=Object.keys(r);n<i.length;n++){var c=i[n];t.push(c+"^"+a(c))}return e.orQuery("multi_match","fields",t,u(s)).orQuery("bool",function(e){return e.orQuery("terms","configurable_children.sku",s.split("-")).orQuery("match_phrase","sku",{query:s,boost:1}).orQuery("match_phrase","configurable_children.sku",{query:s,boost:1})})},""!==s&&(k=i(),h=k?h.query("function_score",k,x):h.query("bool",x)),q=h.build(),r.suggest&&(q.suggest=r.suggest),e.abrupt("return",q);case 35:case"end":return e.stop()}},e,null,[[14,18,22,30],[23,,25,29]])}),(d=function(){var r=this,t=arguments;return new Promise(function(n,s){var o=e.apply(r,t);function i(e){y(o,n,s,i,u,"next",e)}function u(e){y(o,n,s,i,u,"throw",e)}i(void 0)})}).apply(this,arguments)}var b=t(227),m=t.n(b),_=t(5),v=t(148),w=t.n(v),P=t(7),O=t(20);t.d(r,"SearchAdapter",function(){return x});var x=function(){function e(){this.entities=[],this.initBaseTypes()}return e.prototype.search=function(e){return n.b(this,void 0,void 0,function(){var r,t,s,i;return n.d(this,function(n){switch(n.label){case 0:if(!this.entities[e.type])throw new Error("No entity type registered for "+e.type);return r={},e.searchQuery instanceof O.a?[4,g(e.searchQuery)]:[3,2];case 1:return r=n.sent(),""!==e.searchQuery.getSearchText()&&(r.min_score=o.elasticsearch.min_score),[3,3];case 2:r=e.searchQuery,n.label=3;case 3:if(e.hasOwnProperty("groupId")&&null!==e.groupId&&(r.groupId=e.groupId),e.hasOwnProperty("groupToken")&&null!==e.groupToken&&(r.groupToken=e.groupToken),t=null===e.store?Object(P.b)():Object(P.e)(e.store),e.index=t.elasticsearch.index,s=Object(_.j)(t.elasticsearch.host),this.entities[e.type].url&&(s=this.entities[e.type].url),i={size:e.size,from:e.from,sort:e.sort},e._sourceExclude&&(i._source_exclude=e._sourceExclude.join(",")),e._sourceInclude&&(i._source_include=e._sourceInclude.join(",")),e.q&&(i.q=e.q),!e.index||!e.type)throw new Error("Query.index and Query.type are required arguments for executing ElasticSearch query");return"GET"===o.elasticsearch.queryMethod&&(i.request=JSON.stringify(r)),s=(s=s+"/"+encodeURIComponent(e.index)+"/"+encodeURIComponent(e.type)+"/_search")+"?"+w.a.stringify(i),[2,m()(s,{method:o.elasticsearch.queryMethod,mode:"cors",headers:{Accept:"application/json","Content-Type":"application/json"},body:"POST"===o.elasticsearch.queryMethod?JSON.stringify(r):null}).then(function(e){return e.json()})]}})})},e.prototype.handleResult=function(e,r,t,n){if(void 0===t&&(t=0),void 0===n&&(n=50),null===e)throw new Error("Invalid ES result - null not exepcted");if(e.hasOwnProperty("hits"))return{items:Object(s.a)(e.hits.hits,function(e){return Object.assign(e._source,{_score:e._score,slug:e._source.slug?e._source.slug:e._source.hasOwnProperty("url_key")&&o.products.useMagentoUrlKeys?e._source.url_key:e._source.hasOwnProperty("name")?Object(_.m)(e._source.name)+"-"+e._source.id:""})}),total:e.hits.total,start:t,perPage:n,aggregations:e.aggregations,suggestions:e.suggest};throw e.error?new Error(JSON.stringify(e.error)):new Error("Unknown error with elasticsearch result in resultPorcessor for entity type '"+r+"'")},e.prototype.registerEntityType=function(e,r){var t=r.url,n=void 0===t?"":t,s=r.queryProcessor,o=r.resultPorcessor;return this.entities[e]={queryProcessor:s,resultPorcessor:o},""!==n&&(this.entities[e].url=n),this},e.prototype.initBaseTypes=function(){var e=this;this.registerEntityType("product",{queryProcessor:function(e){return e},resultPorcessor:function(r,t,n){return e.handleResult(r,"product",t,n)}}),this.registerEntityType("attribute",{queryProcessor:function(e){return e},resultPorcessor:function(r,t,n){return e.handleResult(r,"attribute",t,n)}}),this.registerEntityType("category",{queryProcessor:function(e){return e},resultPorcessor:function(r,t,n){return e.handleResult(r,"category",t,n)}}),this.registerEntityType("taxrule",{queryProcessor:function(e){return e},resultPorcessor:function(r,t,n){return e.handleResult(r,"taxrule",t,n)}}),this.registerEntityType("review",{queryProcessor:function(e){return e},resultPorcessor:function(r,t,n){return e.handleResult(r,"review",t,n)}}),this.registerEntityType("cms_page",{queryProcessor:function(e){return e},resultPorcessor:function(r,t,n){return e.handleResult(r,"cms_page",t,n)}}),this.registerEntityType("cms_block",{queryProcessor:function(e){return e},resultPorcessor:function(r,t,n){return e.handleResult(r,"cms_block",t,n)}}),this.registerEntityType("cms_hierarchy",{queryProcessor:function(e){return e},resultPorcessor:function(r,t,n){return e.handleResult(r,"cms_hierarchy",t,n)}})},e}()},707:function(e,r,t){"use strict";var n=t(134),s=t(46),o=t(225),i=t(47);var u=function(e,r){var t=-1,n=Object(i.a)(e)?Array(e.length):[];return Object(o.a)(e,function(e,s,o){n[++t]=r(e,s,o)}),n},a=t(18);r.a=function(e,r){return(Object(a.a)(e)?n.a:u)(e,Object(s.a)(r,3))}}}]);
//# sourceMappingURL=vsf-search-adapter-0.46bf610c9f6411e3b58f.js.map